version: "3"

vars:
  BACKEND_BUCKET:
    sh: grep "TF_BACKEND_BUCKET" .env | cut -d '=' -f2 | tr -d '"' | tr -d ' '

tasks:
  setup-backend:
    desc: "æœ€åˆã®æº–å‚™ï¼šãƒã‚±ãƒƒãƒˆä½œæˆ + Terraform åˆæœŸåŒ–"
    cmds:
      - ./setup-backend.sh

      - |
        echo "ğŸ§¹ Cleaning up old terraform cache..."
        rm -rf secrets/.terraform secrets/.terraform.lock.hcl

        NEW_BUCKET=$(grep "^export TF_BACKEND_BUCKET" .env | sed 's/#.*$//' | grep -o '"[^"]*"' | tr -d '"')

        echo "ğŸš€ Initializing secrets with bucket: $NEW_BUCKET"
        terraform -chdir=secrets init -reconfigure \
          -backend-config="bucket=$NEW_BUCKET" \
          -backend-config="prefix=n8n-secrets"

      - |
        echo "ğŸ§¹ Cleaning up old terraform cache..."
        rm -rf project/.terraform project/.terraform.lock.hcl

        NEW_BUCKET=$(grep "^export TF_BACKEND_BUCKET" .env | sed 's/#.*$//' | grep -o '"[^"]*"' | tr -d '"')

        echo "ğŸš€ Initializing project with bucket: $NEW_BUCKET"
        terraform -chdir=project init -reconfigure \
          -backend-config="bucket=$NEW_BUCKET" \
          -backend-config="prefix=n8n"

  plan-secrets:
    desc: "Supabase æƒ…å ±ã®å¤‰æ›´ç¢ºèªï¼ˆplanï¼‰"
    cmds:
      - terraform -chdir=secrets plan -var-file=terraform.tfvars

  plan-app:
    desc: "n8n ã‚¢ãƒ—ãƒªæ§‹æˆã®å¤‰æ›´ç¢ºèªï¼ˆplanï¼‰"
    cmds:
      - terraform -chdir=project plan

  deploy-secrets:
    desc: "Supabase æƒ…å ±ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰"
    cmds:
      - terraform -chdir=secrets apply -var-file=terraform.tfvars

  deploy-secrets-auto:
    desc: "Supabase æƒ…å ±ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰"
    cmds:
      - terraform -chdir=secrets apply -auto-approve -var-file=terraform.tfvars

  deploy-app:
    desc: "n8n ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰ï¼‹URLå†è¨­å®š"
    cmds:
      - terraform -chdir=project apply
      - |
        URL=$(terraform -chdir=project output -raw service_url 2>/dev/null || true); \
        if echo "$URL" | grep -E '^https?://' >/dev/null; then \
          HOST=${URL#https://}; HOST=${HOST#http://}; \
          echo "Cloud Run URL: $URL"; \
          terraform -chdir=project apply \
            -var="n8n_host=${HOST}" -var="n8n_editor_base_url=${URL}"; \
        else \
          echo "Cloud Run ã®URLãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
        fi

  deploy-app-auto:
    desc: "n8n ã‚¢ãƒ—ãƒªã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰ï¼‹URLåæ˜ "
    cmds:
      - terraform -chdir=project apply -auto-approve
      - |
        URL=$(terraform -chdir=project output -raw service_url 2>/dev/null || true); \
        if echo "$URL" | grep -E '^https?://' >/dev/null; then \
          HOST=${URL#https://}; HOST=${HOST#http://}; \
          echo "Cloud Run URL: $URL"; \
          terraform -chdir=project apply -auto-approve \
            -var="n8n_host=${HOST}" -var="n8n_editor_base_url=${URL}"; \
        else \
          echo "Cloud Run ã®URLãŒè¦‹ã¤ã‹ã‚‰ãªã„ã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"; \
        fi

  deploy-all:
    desc: "ä¸€ç™ºãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆsetup-backend â†’ deploy å…¨è‡ªå‹•ï¼‰"
    cmds:
      - task: setup-backend
      - task: deploy-secrets-auto
      - task: deploy-app-auto

  destroy-app:
    desc: "n8n ã‚¢ãƒ—ãƒªã®æ§‹æˆã‚’å‰Šé™¤"
    cmds:
      - |
        terraform -chdir=project init -reconfigure \
          -backend-config="bucket={{.BACKEND_BUCKET}}" \
          -backend-config="prefix=n8n"
      - terraform -chdir=project destroy

  destroy-secrets:
    desc: "Supabase æƒ…å ±ã‚’å‰Šé™¤"
    cmds:
      - |
        terraform -chdir=secrets init -reconfigure \
          -backend-config="bucket={{.BACKEND_BUCKET}}" \
          -backend-config="prefix=n8n-secrets"
      - terraform -chdir=secrets destroy -var-file=terraform.tfvars

  destroy-all:
    desc: "å…¨ã¦å‰Šé™¤ï¼ˆn8n â†’ Supabaseï¼‰"
    cmds:
      - task: destroy-app
      - task: destroy-secrets
